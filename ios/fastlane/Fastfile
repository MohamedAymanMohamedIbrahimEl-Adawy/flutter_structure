

# Run fastlane ci cd on github

default_platform(:ios)

platform :ios do
  ############################################
  # ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯ Xcode Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ø­Ø³Ø¨ CI)
  # This lane is a good practice to ensure a consistent Xcode version.
  ############################################
  private_lane :use_xcode do
    UI.header("ğŸ”§ Selecting Xcode 16.2")
    xcode_select("/Applications/Xcode_16.2.app")
  end

  ############################################
  # ğŸ” Lane Ø¹Ø§Ù… Ù„ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª
  # General lane to set up code signing using `match`.
  # This uses a dedicated CI keychain for security.
  ############################################
  private_lane :setup_code_signing do |options|
    UI.header("ğŸ” Setting up code signing for #{options[:app_identifier]}")

    # Use a temporary keychain specifically for the CI run.
    # This prevents issues with the default keychain on the runner.
    # Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ§Ø³ØªØ®Ø¯Ø§Ù… keychain Ù…Ø¤Ù‚Øª Ø®Ø§Øµ Ø¨Ø§Ù„Ù€ CI Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª.
    setup_ci

    # First, update the project team to ensure consistency.
    # This is a critical step to prevent signing errors.
    # Ø®Ø·ÙˆØ© Ø­Ø§Ø³Ù…Ø©: ØªØ­Ø¯ÙŠØ« ÙØ±ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.
    # We will let Fastlane automatically use the team_id from the Appfile.
    update_project_team(
      path: "Runner.xcodeproj"
    )

    # Run `match` to sync the certificates and provisioning profiles.
    # This will download and install the profile in the keychain.
    # ØªØ´ØºÙŠÙ„ `match` Ù„ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„.
    match(
      type: options[:type] || "appstore",
      app_identifier: options[:app_identifier]
    )
    
    # We will now explicitly set the provisioning profile and code signing identity
    # for the `Runner` target to ensure there are no conflicts. This is the most
    # reliable way to address the "Push Notifications" error.
    # Ø§Ù„Ø¢Ù† Ø³Ù†Ù‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø¨Ø´ÙƒÙ„ ØµØ±ÙŠØ­ Ù„Ø¶Ù…Ø§Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„ØµØ­ÙŠØ­.
    # Ù‡Ø°Ø§ ÙŠØ­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø®Ø§ØµÙŠØ© "Push Notifications" Ø¨Ø´ÙƒÙ„ Ù…Ø¨Ø§Ø´Ø±.
    update_code_signing_settings(
      path: "Runner.xcodeproj",
      targets: ["Runner"],
      use_automatic_signing: false,
      profile_name: "match AppStore #{options[:app_identifier]}",
      code_sign_identity: "Apple Distribution"
    )
  end

  ############################################
  # ğŸ” Lane Ø¹Ø§Ù… Ù„Ø¨Ù†Ø§Ø¡ Ø£ÙŠ flavor
  # General lane to build and upload any flavor.
  # This lane has been updated to use App Store Connect API keys
  # from environment variables, which is a more secure method
  # than storing them directly in the Fastfile.
  ############################################
  private_lane :build_and_upload do |options|
    flavor = options[:flavor]
    identifier = options[:app_identifier]

    # Ensure the correct Xcode version is used
    # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¥ØµØ¯Ø§Ø± Xcode Ø§Ù„ØµØ­ÙŠØ­.
    use_xcode

    # First, run `flutter pub get` to ensure all Dart packages and
    # the necessary `Generated.xcconfig` file are in place.
    # Ø®Ø·ÙˆØ© Ø¬Ø¯ÙŠØ¯Ø©: ØªØ´ØºÙŠÙ„ `flutter pub get` Ø£ÙˆÙ„Ø§Ù‹ Ù„ØªÙˆÙ„ÙŠØ¯ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù„Ø§Ø²Ù…Ø©.
    sh "flutter pub get"

    
    # Install CocoaPods dependencies. This is a crucial step to ensure
    # all native libraries are available for the build.
    # ØªØ«Ø¨ÙŠØª CocoaPods. Ù‡Ø°Ù‡ Ø®Ø·ÙˆØ© Ø­Ø§Ø³Ù…Ø© Ù„Ø¶Ù…Ø§Ù† ØªÙˆÙØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„Ù„Ø¨Ù†Ø§Ø¡.
    cocoapods(
      clean_install: true
    )

    # Set up the code signing using match
    # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… `match`.
    setup_code_signing(
      type: "appstore",
      app_identifier: identifier
    )

    # We now dynamically set the `scheme` and `configuration` based on the flavor
    # you provided. This resolves the `Couldn't find specified scheme` error.
    # ØªÙ… Ø§Ù„Ø¢Ù† ØªØ­Ø¯ÙŠØ« `scheme` Ùˆ `configuration` Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠÙ‹Ø§ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù€ flavor.
    # Ù‡Ø°Ø§ ÙŠØ­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø¹Ø¯Ù… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù€ scheme.
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: flavor, # Use the flavor name as the scheme
      configuration: "Release-#{flavor}", # Use the flavor-specific release configuration
      clean: true,
      # `export_method` must match the `type` used in `match`.
      # ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªØ·Ø§Ø¨Ù‚ Ù‡Ø°Ø§ Ù…Ø¹ `type` ÙÙŠ `match`.
      export_method: "app-store",
      # Set explicit build path and output directory to prevent conflicts and ensure
      # a clean environment for each build.
      # ØªØ¹ÙŠÙŠÙ† Ù…Ø³Ø§Ø± Ø¨Ù†Ø§Ø¡ ØµØ±ÙŠØ­ ÙˆØ¯Ù„ÙŠÙ„ Ø¥Ø®Ø±Ø§Ø¬ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªØ¹Ø§Ø±Ø¶Ø§Øª.
      build_path: "build/ios",
      output_directory: "build/ios/ipa"
    )

    # To securely upload to TestFlight, you must use an App Store Connect API Key.
    # Set the following environment variables in your CI/CD settings:
    # - `APP_STORE_CONNECT_KEY_ID`: Your API Key ID
    # - `APP_STORE_CONNECT_ISSUER_ID`: Your API Key Issuer ID
    # - `APP_STORE_CONNECT_KEY_FILEPATH`: The path to your downloaded .p8 key file
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      key_filepath: ENV["APP_STORE_CONNECT_KEY_FILEPATH"]
    )

    # Upload to TestFlight. This will now work because `build_app`
    # has successfully created a signed IPA.
    # Ø±ÙØ¹ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¥Ù„Ù‰ TestFlight.
    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: true
    )
  end

  ############################################
  # ğŸ Lane Ù„ØªÙˆØ²ÙŠØ¹ dev
  # Lane for dev distribution.
  ############################################
  lane :dev do
    build_and_upload(
      flavor: "dev",
      app_identifier: "com.flutter.structure.dev"
    )
  end

  ############################################
  # ğŸ Lane Ù„ØªÙˆØ²ÙŠØ¹ stage
  # Lane for stage distribution.
  ############################################
  lane :stage do
    build_and_upload(
      flavor: "stage",
      app_identifier: "com.flutter.structure.stage"
    )
  end

  ############################################
  # ğŸ Lane Ù„ØªÙˆØ²ÙŠØ¹ prod
  # Lane for prod distribution.
  ############################################
  lane :prod do
    build_and_upload(
      flavor: "prod",
      app_identifier: "com.flutter.structure"
    )
  end
end
